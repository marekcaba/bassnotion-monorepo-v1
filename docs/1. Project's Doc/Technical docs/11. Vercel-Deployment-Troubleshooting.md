# Vercel Deployment Troubleshooting Guide

## üìã Overview

This document details the deployment issues encountered with the BassNotion monorepo on Vercel and their solutions. The primary challenges involved TypeScript monorepo setup, dependency resolution, and package exports configuration.

**Status**: ‚úÖ **RESOLVED** - Frontend successfully deployed and live
**Deployment URL**: https://bassnotion-frontend.vercel.app

## üö® Problems Encountered

### 1. **Contracts Library Build Failure**
**Error**: 
```
src/validation/auth-schemas.ts(1,19): error TS2307: Cannot find module 'zod' or its corresponding type declarations.
Error: Command "chmod +x setup-contracts.sh && ./setup-contracts.sh" exited with 2
```

**Root Cause**: The `zod` dependency wasn't being properly installed in the contracts library during the Vercel build process.

### 2. **npm list Validation Errors**
**Error**:
```
npm error code ELSPROBLEMS
npm error invalid: typescript@ /vercel/path0/libs/contracts/node_modules/typescript
npm error invalid: zod@ /vercel/path0/libs/contracts/node_modules/zod
Error: Command "chmod +x setup-contracts.sh && ./setup-contracts.sh" exited with 1
```

**Root Cause**: The `npm list` command was failing due to version validation conflicts in the dependency tree, even though packages were correctly installed.

### 3. **Package.json Exports Mismatch**
**Error**: Module resolution failures in production environment

**Root Cause**: Package.json exports were pointing to `./dist/src/index.js` but TypeScript compiler outputs to `./dist/index.js`.

## üîß Solutions Applied

### Solution 1: Enhanced Setup Script with Robust Dependency Handling

**Before** (Failed approach):
```bash
echo "Installing contracts dependencies..."
npm install --no-optional --no-audit --no-fund

echo "Checking installed packages:"
npm list  # This was failing with validation errors

echo "Building contracts..."
npm run build
```

**After** (Working solution):
```bash
echo "Installing contracts dependencies..."
npm install --no-optional --no-audit --no-fund --verbose

# Use direct file system checks instead of npm list
echo "Checking if node_modules directory exists:"
ls -la node_modules/ || echo "node_modules not found"

# Verify dependencies by checking directories
if [ ! -d "node_modules/zod" ]; then
  echo "WARNING: zod not found in node_modules, installing explicitly..."
  npm install zod@^3.25.32 --no-optional --no-audit --no-fund
fi

if [ ! -d "node_modules/typescript" ]; then
  echo "WARNING: typescript not found in node_modules, installing explicitly..."
  npm install typescript@5.3.3 --no-optional --no-audit --no-fund
fi

echo "Key dependencies check:"
echo "Zod: $([ -d "node_modules/zod" ] && echo "‚úì Found" || echo "‚úó Missing")"
echo "TypeScript: $([ -d "node_modules/typescript" ] && echo "‚úì Found" || echo "‚úó Missing")"

echo "Building contracts..."
npm run build
```

**Key Changes**:
- Replaced `npm list` with direct file system checks
- Added explicit fallback installation for missing dependencies
- Added clear visual indicators for dependency status
- Improved error handling and debugging output

### Solution 2: Fixed Package.json Exports

**Before** (Incorrect paths):
```json
{
  "main": "./dist/src/index.js",
  "types": "./dist/src/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/src/index.js",
      "types": "./dist/src/index.d.ts"
    }
  }
}
```

**After** (Correct paths):
```json
{
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  }
}
```

**Explanation**: TypeScript compiles `src/index.ts` ‚Üí `dist/index.js`, not `dist/src/index.js`.

### Solution 3: Updated TypeScript Path Mappings

**Before** (Mismatched paths):
```json
{
  "paths": {
    "@bassnotion/contracts": ["libs/contracts/dist/src/index.d.ts"]
  }
}
```

**After** (Aligned paths):
```json
{
  "paths": {
    "@bassnotion/contracts": ["libs/contracts/dist/index.d.ts"]
  }
}
```

## üéØ Key Learnings

### 1. **Vercel Monorepo Behavior**
- Vercel automatically detects monorepo structure and runs from `apps/frontend/` directory
- All relative paths in setup scripts are relative to the detected working directory
- npm behavior differs between local development and Vercel's CI environment

### 2. **npm vs pnpm in CI**
- Local development uses pnpm, but Vercel setup scripts use npm
- Dependency resolution and validation behave differently between package managers
- `npm list` can fail even when packages are correctly installed

### 3. **TypeScript Module Resolution**
- Package.json exports must match actual TypeScript compiler output
- Path mappings in tsconfig.json must align with package.json exports
- Development vs production environments handle module resolution differently

### 4. **Dependency Installation Strategies**
- Direct file system checks are more reliable than package manager validation commands
- Explicit fallback installation prevents silent dependency failures
- Verbose logging is crucial for debugging CI environments

## üìÅ Working Configuration Files

### `apps/frontend/setup-contracts.sh` (Final Version)
```bash
#!/bin/bash
set -e

echo "=== BassNotion Frontend Setup Script ==="
echo "Current directory: $(pwd)"
echo "Node version: $(node --version)"
echo "NPM version: $(npm --version)"

echo "Installing npm dependencies..."
npm install --no-optional --no-audit --no-fund

echo "Building contracts library..."
cd ../../libs/contracts
echo "Contracts directory: $(pwd)"

# Check if package.json exists
if [ ! -f "package.json" ]; then
  echo "ERROR: package.json not found in contracts directory"
  exit 1
fi

echo "Contracts package.json content:"
cat package.json

# Install dependencies with verbose logging
echo "Installing contracts dependencies..."
npm install --no-optional --no-audit --no-fund --verbose

# Check if dependencies were installed (use ls instead of npm list to avoid version conflicts)
echo "Checking if node_modules directory exists:"
ls -la node_modules/ || echo "node_modules not found"

# Verify zod is available by checking the directory
if [ ! -d "node_modules/zod" ]; then
  echo "WARNING: zod not found in node_modules, installing explicitly..."
  npm install zod@^3.25.32 --no-optional --no-audit --no-fund
fi

# Verify typescript is available
if [ ! -d "node_modules/typescript" ]; then
  echo "WARNING: typescript not found in node_modules, installing explicitly..."
  npm install typescript@5.3.3 --no-optional --no-audit --no-fund
fi

echo "Key dependencies check:"
echo "Zod: $([ -d "node_modules/zod" ] && echo "‚úì Found" || echo "‚úó Missing")"
echo "TypeScript: $([ -d "node_modules/typescript" ] && echo "‚úì Found" || echo "‚úó Missing")"

echo "Building contracts..."
npm run build

# Verify build output
if [ ! -f "dist/index.js" ]; then
  echo "ERROR: Contracts build failed - dist/index.js not found"
  echo "Contents of dist directory:"
  ls -la dist/ || echo "dist directory does not exist"
  exit 1
fi

echo "Contracts build successful, files:"
ls -la dist/

cd ../../apps/frontend
echo "Back to frontend directory: $(pwd)"

echo "Setting up contracts library..."
mkdir -p node_modules/@bassnotion/contracts

# Copy all files from contracts library
cp -r ../../libs/contracts/* node_modules/@bassnotion/contracts/

# Verify the copy worked
if [ ! -f "node_modules/@bassnotion/contracts/dist/index.js" ]; then
  echo "ERROR: Contracts copy failed - dist/index.js not found in node_modules"
  exit 1
fi

echo "Contracts library copied successfully:"
ls -la node_modules/@bassnotion/contracts/
echo "Contracts dist files:"
ls -la node_modules/@bassnotion/contracts/dist/

echo "Contracts library setup complete!"
```

### `libs/contracts/package.json` (Final Version)
```json
{
  "name": "@bassnotion/contracts",
  "version": "0.1.0",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  },
  "scripts": {
    "build": "npx --package=typescript tsc",
    "typecheck": "npx --package=typescript tsc --noEmit"
  },
  "dependencies": {
    "zod": "^3.25.32",
    "typescript": "5.3.3"
  }
}
```

### `tsconfig.base.json` (Final Version)
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@bassnotion/backend": ["apps/backend/src/index.ts"],
      "@bassnotion/contracts": ["libs/contracts/dist/index.d.ts"],
      "@bassnotion/frontend": ["apps/frontend/src/index.ts"]
    }
  }
}
```

## üîç Troubleshooting Guide

### Common Error Patterns

#### Error: "Cannot find module 'zod'"
**Symptoms**: TypeScript compilation fails during contracts build
**Solution**: Check if dependencies are properly installed, use explicit installation as fallback

#### Error: "npm list failed with code ELSPROBLEMS"
**Symptoms**: Setup script exits with error 1 even though packages are installed
**Solution**: Replace `npm list` with direct file system checks (`ls -la node_modules/`)

#### Error: "Cannot find module '@bassnotion/contracts'"
**Symptoms**: Frontend build fails when importing from contracts library
**Solution**: Verify package.json exports match TypeScript build output paths

### Debugging Steps

1. **Check dependency installation**:
   ```bash
   ls -la libs/contracts/node_modules/
   ```

2. **Verify contracts build output**:
   ```bash
   ls -la libs/contracts/dist/
   ```

3. **Test contracts import locally**:
   ```bash
   cd apps/frontend
   node -e "console.log(require.resolve('@bassnotion/contracts'))"
   ```

4. **Check TypeScript compilation**:
   ```bash
   cd libs/contracts
   npx tsc --noEmit
   ```

### Prevention Strategies

1. **Always use explicit dependency installation** in CI environments
2. **Test package.json exports** match actual build output
3. **Use file system checks** instead of package manager validation commands
4. **Maintain alignment** between package.json exports and TypeScript path mappings
5. **Add comprehensive logging** to setup scripts for easier debugging

## üìä Deployment Timeline

1. **Initial Failure**: Module resolution errors and dependency issues
2. **First Fix**: Enhanced setup script with better dependency handling
3. **Second Fix**: Corrected package.json exports paths
4. **Third Fix**: Updated TypeScript path mappings
5. **Final Success**: ‚úÖ Deployment working and live

## üéâ Current Status

- **Deployment Status**: ‚úÖ Live and functional
- **Build Time**: ~2-3 minutes
- **Health Check**: Passing
- **Module Resolution**: Working correctly
- **Dependencies**: All correctly installed and available

**Live URL**: https://bassnotion-frontend.vercel.app

---

**Last Updated**: May 2025  
**Status**: ‚úÖ Production Ready  
**Maintainer**: Development Team 