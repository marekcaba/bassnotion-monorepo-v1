# BassNotion Deployment Setup Guide

## üìã Overview

This document provides a complete guide for deploying the BassNotion monorepo, including frontend (Next.js) and backend (NestJS) services. Follow this guide to ensure consistent and successful deployments.

## üèóÔ∏è Architecture

### Current Deployment Stack
- **Frontend**: Next.js 15.3.2 deployed on Vercel
- **Backend**: NestJS deployed on Railway using Docker
- **Database**: Supabase (PostgreSQL)
- **Package Manager**: pnpm (development), npm (production builds)

### Live URLs
- **Frontend**: https://bassnotion-frontend.vercel.app
- **Backend**: https://backend-production-612c.up.railway.app
- **Database**: Supabase project (configured via environment variables)

## üöÄ Frontend Deployment (Vercel)

### Prerequisites
- Vercel account with access to the project
- Repository access
- Environment variables configured

### Configuration Files

#### 1. Root `vercel.json`
```json
{
  "installCommand": "cd apps/frontend && npm install",
  "buildCommand": "cd apps/frontend && npm run build",
  "outputDirectory": "apps/frontend/.next"
}
```

#### 2. Root `.vercelignore`
```
# Exclude pnpm files to force npm usage
pnpm-lock.yaml
pnpm-workspace.yaml

# Exclude other apps and directories
apps/backend/
libs/
bmad-agent/
deploy/
docs/
tmp/
.nx/
*.log
node_modules/
```

### Vercel Project Settings

#### Critical Settings in Vercel Dashboard:
1. **Root Directory**: `apps/frontend`
2. **Framework**: Next.js (auto-detected)
3. **Build Command**: `npm run build` (configured in vercel.json)
4. **Install Command**: `npm install` (configured in vercel.json)
5. **Output Directory**: `.next` (Next.js default)

### Environment Variables (Frontend)
```bash
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### Deployment Process

#### Method 1: Git-based Deployment (Recommended)
- Push changes to main branch
- Vercel automatically deploys via GitHub integration
- Uses configuration from `vercel.json`

#### Method 2: CLI Deployment
```bash
# From monorepo root
npx vercel --prod
```

### Common Issues & Solutions

#### Issue: "No Next.js version detected"
**Cause**: Vercel using pnpm symlinks instead of direct npm installation
**Solution**:
1. Ensure `.vercelignore` excludes pnpm files
2. Root Directory set to `apps/frontend` in Vercel dashboard
3. Configuration in `vercel.json` forces npm usage

#### Issue: pnpm network errors (ERR_INVALID_THIS)
**Cause**: Vercel detecting pnpm-lock.yaml and using pnpm
**Solution**: `.vercelignore` excludes pnpm files, forcing npm usage

## üõ†Ô∏è Backend Deployment (Railway)

### Prerequisites
- Railway account with project access
- Docker support enabled
- Environment variables configured

### Configuration Files

#### 1. `Dockerfile.final` (Multi-stage build)
```dockerfile
# Build stage
FROM node:20-alpine AS builder
WORKDIR /app

# Copy package files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/backend/package.json ./apps/backend/package.json
COPY libs/contracts/package.json ./libs/contracts/package.json

# Install pnpm and dependencies
RUN npm install -g pnpm
RUN pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Build contracts library first
RUN pnpm nx build @bassnotion/contracts

# Build backend
RUN pnpm nx build @bassnotion/backend --prod

# Production stage
FROM node:20-alpine AS production
WORKDIR /app

# Copy built application
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

EXPOSE 3000
CMD ["node", "dist/apps/backend/main.js"]
```

#### 2. `.dockerignore`
```
node_modules
.git
.nx
apps/frontend
docs
bmad-agent
deploy
tmp
*.log
.env.local
.env.development
```

#### 3. `railway.json`
```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "DOCKERFILE",
    "dockerfilePath": "Dockerfile.final",
    "watchPatterns": [
      "apps/backend/**",
      "libs/**",
      "package.json",
      "pnpm-lock.yaml",
      "Dockerfile.final",
      "railway.json"
    ]
  },
  "deploy": {
    "healthcheckPath": "/api/health",
    "healthcheckTimeout": 180,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

### Environment Variables (Backend)
```bash
NODE_ENV=production
PORT=3000
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_service_role_key
```

### Deployment Process

#### Automatic Deployment
- Push changes to main branch
- Railway automatically builds and deploys using Docker
- Health check endpoint: `/api/health`

#### Manual Deployment
```bash
# Using Railway CLI
railway deploy
```

### Health Check
The backend includes a health check endpoint at `/api/health` that Railway uses to verify deployment success.

## üóÑÔ∏è Database Setup (Supabase)

### Configuration
- **Provider**: Supabase (PostgreSQL)
- **Connection**: Via Supabase JavaScript client
- **Authentication**: Service role key for backend, anon key for frontend

### Environment Variables
```bash
# Backend (Service Role - Full Access)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your_service_role_key

# Frontend (Anonymous - Limited Access)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
```

## üîÑ CI/CD Pipeline

### GitHub Actions
- **Trigger**: Push to main branch
- **Frontend**: Automatic deployment via Vercel GitHub integration
- **Backend**: Automatic deployment via Railway GitHub integration

### Deployment Flow
1. Code pushed to main branch
2. Vercel builds and deploys frontend
3. Railway builds Docker image and deploys backend
4. Health checks verify successful deployment

## üö® Troubleshooting

### Frontend Issues
- **Build failures**: Check Next.js configuration and dependencies
- **Environment variables**: Verify `NEXT_PUBLIC_` prefix for client-side variables

### Backend Issues
- **Docker build failures**: Check Dockerfile and dependency installation
- **Health check failures**: Verify `/api/health` endpoint is accessible
- **Database connection**: Verify Supabase credentials and network access

### Common Solutions
1. **Clear deployment cache**: Redeploy from scratch
2. **Check logs**: Use Vercel/Railway dashboards for detailed logs
3. **Environment variables**: Verify all required variables are set
4. **Dependencies**: Ensure all packages are properly installed

## üìä Monitoring

### Health Checks
- **Frontend**: Vercel automatic monitoring
- **Backend**: Railway health check at `/api/health`
- **Database**: Supabase dashboard monitoring

### Logs
- **Frontend**: Vercel dashboard
- **Backend**: Railway dashboard
- **Database**: Supabase logs

## üîê Security

### Environment Variables
- Never commit sensitive keys to repository
- Use different keys for development/production
- Rotate keys regularly

### CORS Configuration
- Frontend and backend properly configured for cross-origin requests
- Supabase RLS (Row Level Security) policies in place

---

**Last Updated**: May 2025
**Status**: ‚úÖ Production Ready
**Deployment URLs**: 
- Frontend: https://bassnotion-frontend.vercel.app
- Backend: https://backend-production-612c.up.railway.app 