# E2E Testing Setup - BassNotion

## Overview

BassNotion uses **Playwright** for end-to-end testing of the frontend application. This setup provides comprehensive browser automation testing across multiple browsers and devices.

## Architecture

### Backend E2E Testing ✅ COMPLETE
- **Framework**: Vitest with Node.js environment
- **Location**: `apps/backend/e2e/`
- **Test Files**: 
  - `youtube-exerciser.e2e-spec.ts`
  - `auth.e2e-spec.ts`
- **Infrastructure**: Complete with database fixtures, factories, mocks, migrations
- **Configuration**: `vitest.e2e.config.ts` with Supabase test environment
- **Command**: `npx nx test:e2e @bassnotion/backend`

### Frontend E2E Testing ✅ COMPLETE
- **Framework**: Playwright v1.52.0
- **Location**: `apps/frontend-e2e/`
- **Browsers**: Chromium, Firefox, WebKit, Mobile Chrome, Mobile Safari, Edge
- **Configuration**: ES module compatible with Nx integration
- **Command**: `npx nx e2e frontend-e2e`

## Project Structure

```
apps/frontend-e2e/
├── src/
│   ├── pages/                    # Page Object Models
│   │   └── HomePage.ts          # Homepage POM with utilities
│   ├── example.spec.ts          # Basic functionality tests
│   └── user-journey.spec.ts     # Comprehensive user flow tests
├── screenshots/                 # Test artifacts directory
├── playwright.config.ts         # Playwright configuration
├── project.json                 # Nx project configuration
├── tsconfig.json               # TypeScript configuration
└── .eslintrc.json              # ESLint configuration
```

## Configuration Files

### Playwright Configuration (`playwright.config.ts`)
- **ES Module Compatible**: Uses `fileURLToPath(import.meta.url)` instead of `__filename`
- **Nx Integration**: Uses `nxE2EPreset` for seamless Nx workflow
- **Web Server**: Automatically starts frontend dev server on `http://localhost:4200`
- **Multi-Browser**: Tests across 7 different browser/device combinations
- **Artifacts**: Screenshots, videos, traces on failure
- **Reporters**: HTML, JUnit, JSON for CI/CD integration

### TypeScript Configuration
- **DOM Types**: Includes DOM lib for browser APIs
- **Playwright Types**: Full type support for Playwright APIs
- **ES2022**: Modern JavaScript features support

## Test Categories

### 1. Basic Functionality Tests (`example.spec.ts`)
- Homepage loading and title verification
- Navigation element presence
- Responsive design testing
- Screenshot capture for visual verification

### 2. User Journey Tests (`user-journey.spec.ts`)
- Complete user flow testing
- Form interaction testing
- Button interaction testing
- JavaScript error detection
- Basic accessibility checks

### 3. Page Object Model (`pages/HomePage.ts`)
- Reusable page interaction methods
- Screenshot utilities
- Responsive design verification
- Accessibility testing helpers
- JavaScript error monitoring

## Key Features

### Multi-Browser Testing
```typescript
projects: [
  { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
  { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
  { name: 'webkit', use: { ...devices['Desktop Safari'] } },
  { name: 'Mobile Chrome', use: { ...devices['Pixel 5'] } },
  { name: 'Mobile Safari', use: { ...devices['iPhone 12'] } },
  { name: 'Microsoft Edge', use: { ...devices['Desktop Edge'] } },
  { name: 'Google Chrome', use: { ...devices['Desktop Chrome'] } }
]
```

### Responsive Testing
- Desktop (1920x1080)
- Tablet (768x1024) 
- Mobile (375x667)
- Automatic screenshot capture for each viewport

### Error Detection
- JavaScript runtime errors
- Console error monitoring
- Network failure detection
- React hydration issues

### Accessibility Testing
- Heading structure validation
- Image alt text verification
- Form label association
- Color contrast basic checks

## Commands

### Run All E2E Tests
```bash
npx nx e2e frontend-e2e
```

### Run with Browser UI (Headed Mode)
```bash
npx nx e2e frontend-e2e --headed
```

### Run Specific Test File
```bash
npx nx e2e frontend-e2e --grep "User Journey"
```

### Debug Mode
```bash
npx nx e2e frontend-e2e --debug
```

### Generate Test Report
```bash
npx playwright show-report dist/apps/frontend-e2e/html-report
```

## CI/CD Integration

### Artifacts Generated
- **HTML Report**: `dist/apps/frontend-e2e/html-report/`
- **JUnit XML**: `dist/apps/frontend-e2e/junit.xml`
- **JSON Results**: `dist/apps/frontend-e2e/test-results.json`
- **Screenshots**: `dist/apps/frontend-e2e/test-results/`
- **Videos**: `dist/apps/frontend-e2e/test-results/`
- **Traces**: `dist/apps/frontend-e2e/test-results/`

### Environment Variables
- `BASE_URL`: Override default localhost URL for deployed environments
- `CI`: Automatically detected, disables server reuse

## Best Practices

### Page Object Model Usage
```typescript
import { HomePage } from './pages/HomePage';

test('homepage functionality', async ({ page }) => {
  const homePage = new HomePage(page);
  await homePage.goto();
  await homePage.verifyPageTitle(/BassNotion/);
  await homePage.takeScreenshot('homepage-test');
});
```

### Error Monitoring
```typescript
test('detect JavaScript errors', async ({ page }) => {
  const errors = await homePage.checkForJavaScriptErrors();
  expect(errors).toHaveLength(0);
});
```

### Responsive Testing
```typescript
test('responsive design', async ({ page }) => {
  const homePage = new HomePage(page);
  await homePage.goto();
  await homePage.verifyResponsiveDesign();
});
```

## Dependencies

### Core Dependencies
- `@playwright/test`: ^1.52.0
- `@nx/playwright`: 21.1.2

### Development Dependencies
- TypeScript DOM types for browser APIs
- ESLint configuration for test files
- Nx integration for monorepo workflow

## Integration with Existing Stack

### Frontend Development Server
- Automatically starts Next.js dev server
- Waits for server to be ready before running tests
- Reuses existing server in development

### Test Data Management
- Uses consistent test data factories
- Integrates with backend test database
- Supports data seeding and cleanup

## Validation Testing Patterns

### Form Validation Testing

Test Zod schema validation in forms:

```typescript
// apps/frontend-e2e/src/validation.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Form Validation', () => {
  test('should show validation errors for invalid registration data', async ({ page }) => {
    await page.goto('/auth-demo');
    
    // Switch to registration tab
    await page.click('[data-testid="registration-tab"]');
    
    // Submit empty form
    await page.click('button[type="submit"]');
    
    // Check for validation error messages
    await expect(page.locator('text=Email is required')).toBeVisible();
    await expect(page.locator('text=Password is required')).toBeVisible();
    
    // Test invalid email format
    await page.fill('input[name="email"]', 'invalid-email');
    await page.blur('input[name="email"]');
    await expect(page.locator('text=Invalid email format')).toBeVisible();
    
    // Test weak password
    await page.fill('input[name="password"]', '123');
    await page.blur('input[name="password"]');
    await expect(page.locator('text=Password must be at least 8 characters')).toBeVisible();
  });
  
  test('should accept valid registration data', async ({ page }) => {
    await page.goto('/auth-demo');
    await page.click('[data-testid="registration-tab"]');
    
    // Fill valid data
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'SecurePass123!');
    await page.fill('input[name="confirmPassword"]', 'SecurePass123!');
    
    // Form should be valid (submit button enabled)
    await expect(page.locator('button[type="submit"]:not([disabled])')).toBeVisible();
    
    // No validation errors should be visible
    await expect(page.locator('.error, [role="alert"]')).not.toBeVisible();
  });
  
  test('should validate password confirmation match', async ({ page }) => {
    await page.goto('/auth-demo');
    await page.click('[data-testid="registration-tab"]');
    
    await page.fill('input[name="password"]', 'SecurePass123!');
    await page.fill('input[name="confirmPassword"]', 'DifferentPass123!');
    await page.blur('input[name="confirmPassword"]');
    
    await expect(page.locator('text=Passwords do not match')).toBeVisible();
  });
});
```

### API Validation Testing

Test backend validation responses:

```typescript
test.describe('API Validation', () => {
  test('should handle backend validation errors', async ({ page }) => {
    // Mock API response with validation error
    await page.route('/api/auth/register', (route) => {
      route.fulfill({
        status: 400,
        contentType: 'application/json',
        body: JSON.stringify({
          message: 'Validation failed',
          zodError: {
            errors: [
              {
                path: ['email'],
                message: 'Email already exists',
                code: 'custom'
              }
            ]
          }
        })
      });
    });
    
    await page.goto('/auth-demo');
    await page.click('[data-testid="registration-tab"]');
    
    // Fill valid form data
    await page.fill('input[name="email"]', 'existing@example.com');
    await page.fill('input[name="password"]', 'SecurePass123!');
    await page.fill('input[name="confirmPassword"]', 'SecurePass123!');
    
    // Submit form
    await page.click('button[type="submit"]');
    
    // Check for server validation error
    await expect(page.locator('text=Email already exists')).toBeVisible();
  });
  
  test('should handle network errors gracefully', async ({ page }) => {
    // Mock network failure
    await page.route('/api/auth/register', (route) => {
      route.abort();
    });
    
    await page.goto('/auth-demo');
    await page.click('[data-testid="registration-tab"]');
    
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'SecurePass123!');
    await page.fill('input[name="confirmPassword"]', 'SecurePass123!');
    
    await page.click('button[type="submit"]');
    
    // Check for error handling
    await expect(page.locator('text=Network error')).toBeVisible();
  });
});
```

### Real-time Validation Testing

Test real-time validation feedback:

```typescript
test.describe('Real-time Validation', () => {
  test('should provide immediate feedback on input change', async ({ page }) => {
    await page.goto('/auth-demo');
    await page.click('[data-testid="registration-tab"]');
    
    const emailInput = page.locator('input[name="email"]');
    const passwordInput = page.locator('input[name="password"]');
    
    // Test email validation on change
    await emailInput.fill('invalid');
    await expect(page.locator('text=Invalid email format')).toBeVisible();
    
    await emailInput.fill('valid@example.com');
    await expect(page.locator('text=Invalid email format')).not.toBeVisible();
    
    // Test password strength indicator
    await passwordInput.fill('weak');
    await expect(page.locator('text=Password must be at least 8 characters')).toBeVisible();
    
    await passwordInput.fill('StrongPassword123!');
    await expect(page.locator('text=Password must be at least 8 characters')).not.toBeVisible();
  });
  
  test('should disable submit button when form is invalid', async ({ page }) => {
    await page.goto('/auth-demo');
    await page.click('[data-testid="registration-tab"]');
    
    const submitButton = page.locator('button[type="submit"]');
    
    // Initially disabled (empty form)
    await expect(submitButton).toBeDisabled();
    
    // Still disabled with invalid data
    await page.fill('input[name="email"]', 'invalid-email');
    await expect(submitButton).toBeDisabled();
    
    // Enabled with valid data
    await page.fill('input[name="email"]', 'valid@example.com');
    await page.fill('input[name="password"]', 'SecurePass123!');
    await page.fill('input[name="confirmPassword"]', 'SecurePass123!');
    await expect(submitButton).toBeEnabled();
  });
});
```

### Validation Testing Utilities

Create reusable validation testing utilities:

```typescript
// apps/frontend-e2e/src/pages/ValidationTestPage.ts
import { Page } from '@playwright/test';

export class ValidationTestPage {
  constructor(private page: Page) {}
  
  async fillRegistrationForm(data: {
    email?: string;
    password?: string;
    confirmPassword?: string;
  }) {
    if (data.email !== undefined) {
      await this.page.fill('input[name="email"]', data.email);
    }
    if (data.password !== undefined) {
      await this.page.fill('input[name="password"]', data.password);
    }
    if (data.confirmPassword !== undefined) {
      await this.page.fill('input[name="confirmPassword"]', data.confirmPassword);
    }
  }
  
  async expectValidationError(field: string, message: string) {
    const errorLocator = this.page.locator(`[data-field="${field}"] .error, [data-field="${field}"] + .error`);
    await expect(errorLocator).toContainText(message);
  }
  
  async expectNoValidationErrors() {
    await expect(this.page.locator('.error, [role="alert"]')).not.toBeVisible();
  }
  
  async expectSubmitButtonState(enabled: boolean) {
    const submitButton = this.page.locator('button[type="submit"]');
    if (enabled) {
      await expect(submitButton).toBeEnabled();
    } else {
      await expect(submitButton).toBeDisabled();
    }
  }
  
  async mockValidationError(endpoint: string, errors: Array<{ path: string[]; message: string }>) {
    await this.page.route(endpoint, (route) => {
      route.fulfill({
        status: 400,
        contentType: 'application/json',
        body: JSON.stringify({
          message: 'Validation failed',
          zodError: { errors }
        })
      });
    });
  }
}
```

This validation testing approach ensures:
- **Form Validation**: Client-side validation behavior
- **API Integration**: Backend validation error handling  
- **Real-time Feedback**: Immediate validation responses
- **Error Handling**: Network and server error scenarios
- **User Experience**: Submit button states and error display
- **Reusability**: Common testing utilities and patterns

## Future Enhancements

### Potential Additions
1. **Visual Regression Testing**: Percy or Chromatic integration
2. **Accessibility Testing**: axe-core integration for comprehensive a11y testing
3. **Performance Testing**: Lighthouse CI integration
4. **API Mocking**: MSW integration for isolated frontend testing
5. **Database Seeding**: Test data management for consistent test scenarios

### Advanced Features
- Cross-browser screenshot comparison
- Automated accessibility audits
- Performance budget enforcement
- Visual diff reporting
- Parallel test execution optimization

## Troubleshooting

### Common Issues

1. **ES Module Errors**: Ensure `fileURLToPath(import.meta.url)` is used instead of `__filename`
2. **Server Not Starting**: Check if port 4200 is available
3. **Browser Installation**: Run `npx playwright install` if browsers are missing
4. **TypeScript Errors**: Ensure DOM types are included in tsconfig.json

### Debug Commands
```bash
# Install browsers
npx playwright install

# Run with debug mode
npx playwright test --debug

# Show test report
npx playwright show-report

# Check configuration
npx playwright test --list
```

This comprehensive e2e testing setup ensures robust quality assurance for the BassNotion frontend application across multiple browsers and devices. 