# Railway Deployment Troubleshooting Guide

## üìã Overview

This document details the deployment issues encountered with the BassNotion monorepo backend on Railway and their solutions. The primary challenges involved Docker monorepo setup, TypeScript module resolution, and Nx build system configuration.

**Status**: ‚úÖ **RESOLVED** - Backend successfully deployed and live  
**Deployment URL**: https://backend-production-612c.up.railway.app

## üö® Problems Encountered

### 1. **Health Check Failures**
**Error**: 
```
Attempt #1 failed with service unavailable. Continuing to retry for 2m59s
Attempt #2 failed with service unavailable. Continuing to retry for 2m48s
...
1/1 replicas never became healthy!
Healthcheck failed!
```

**Root Cause**: Backend application wasn't starting properly due to module resolution issues.

### 2. **Deployment Skipped - Watch Patterns**
**Error**:
```
No changed files matched patterns: apps/backend/**, libs/contracts/**, package.json, pnpm-lock.yaml, Dockerfile.final, railway.json
```

**Root Cause**: Railway's watch patterns didn't include files that were modified (like `tsconfig.base.json`).

### 3. **TypeScript Module Resolution Failures**
**Error**:
```
apps/backend/src/domains/user/auth/auth.controller.ts:1:27 - error TS2307: Cannot find module '@bassnotion/contracts' or its corresponding type declarations.
```

**Root Cause**: Backend couldn't import from the contracts library during TypeScript compilation in Docker.

### 4. **Nx Daemon Issues in Docker**
**Error**:
```
Calculating the project graph on the Nx Daemon is taking longer than expected.
NX   [object Object]
```

**Root Cause**: Nx daemon causing cryptic errors and build failures in containerized environment.

### 5. **AuthUser Type Errors**
**Error**:
```
apps/backend/e2e/factories/user.factory.ts:222:9 - error TS2353: Object literal may only specify known properties, and 'id' does not exist in type 'AuthUser'.
```

**Root Cause**: TypeScript couldn't resolve the User type from contracts, making AuthUser incomplete.

## üîß Solutions Applied

### Solution 1: Fixed Watch Patterns

**Before** (Missing critical files):
```json
"watchPatterns": [
  "apps/backend/**",
  "libs/contracts/**",
  "package.json",
  "pnpm-lock.yaml",
  "Dockerfile.final",
  "railway.json"
]
```

**After** (Added missing dependencies):
```json
"watchPatterns": [
  "apps/backend/**",
  "libs/contracts/**",
  "package.json",
  "pnpm-lock.yaml",
  "Dockerfile.final",
  "railway.json",
  "tsconfig.base.json"
]
```

**Key Changes**:
- Added `tsconfig.base.json` to watch patterns
- Updated deployment trigger variable to force rebuild

### Solution 2: Disabled Nx Daemon

**Problem**: Cryptic `[object Object]` errors with no details

**Solution**:
```dockerfile
# Build backend
ENV NX_DAEMON=false
RUN pnpm nx build @bassnotion/backend --prod
```

**Result**: Clear error messages revealing the actual TypeScript compilation issues.

### Solution 3: Fixed Package.json Exports and Path Mappings

**Fixed contracts package.json exports**:
```json
{
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  }
}
```

**Fixed tsconfig.base.json path mapping**:
```json
{
  "paths": {
    "@bassnotion/contracts": ["libs/contracts/dist/index.d.ts"]
  }
}
```

### Solution 4: Docker Module Resolution Fix

**Final Working Solution**:
```dockerfile
# Multi-stage build for BassNotion monorepo
FROM node:20-alpine AS builder
WORKDIR /app

# Copy package files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/backend/package.json ./apps/backend/package.json
COPY libs/contracts/package.json ./libs/contracts/package.json

# Install pnpm and dependencies
RUN npm install -g pnpm
RUN pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Build contracts library first
RUN pnpm nx build @bassnotion/contracts

# Make contracts available for backend build
RUN mkdir -p node_modules/@bassnotion/contracts && \
    cp -r libs/contracts/dist/* node_modules/@bassnotion/contracts/ && \
    cp libs/contracts/package.json node_modules/@bassnotion/contracts/

# Build backend
ENV NX_DAEMON=false
RUN pnpm nx build @bassnotion/backend --prod

# Production stage
FROM node:20-alpine AS production
WORKDIR /app

# Copy built application
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

EXPOSE 3000
CMD ["node", "dist/apps/backend/main.js"]
```

**Key Elements**:
1. **Build contracts first**: Ensure compiled output exists
2. **Copy to node_modules**: Make available for TypeScript module resolution
3. **Disable Nx daemon**: Avoid containerization issues
4. **Copy entire environment**: Simple production stage with working setup

## üéØ Key Learnings

### 1. **Docker Monorepo Challenges**
- Workspace dependencies (`workspace:*`) don't work in containerized builds
- Need explicit copying of built libraries to `node_modules` locations
- TypeScript module resolution in Docker differs from local development

### 2. **Nx in Docker Environments**
- Nx daemon can cause issues in containers
- Always use `ENV NX_DAEMON=false` for reliable builds
- Cryptic errors often hide simple module resolution issues

### 3. **Railway Deployment Patterns**
- Watch patterns must include all files that affect build
- Simple production stages work better than complex dependency management
- Health checks require actual application startup, not just successful builds

### 4. **Module Resolution Strategy**
- Build contracts library first
- Copy built output to expected module location
- Ensure package.json exports match actual build structure
- Align TypeScript path mappings with runtime module resolution

## üìÅ What DIDN'T Work (Failed Attempts)

### ‚ùå Attempt 1: Workspace Dependencies
```dockerfile
# Tried relying on pnpm workspace resolution
RUN pnpm install --frozen-lockfile --prod
```
**Failed**: Production dependencies don't understand `workspace:*` syntax

### ‚ùå Attempt 2: Symlinks in Docker
```dockerfile
RUN mkdir -p node_modules/@bassnotion && \
    ln -sf ../../libs/contracts node_modules/@bassnotion/contracts
```
**Failed**: Symlinks didn't work for TypeScript module resolution

### ‚ùå Attempt 3: Complex Production Dependencies
```dockerfile
# Install only production dependencies
RUN pnpm install --frozen-lockfile --prod
# Copy built contracts library manually
COPY --from=builder /app/libs/contracts/dist ./node_modules/@bassnotion/contracts/dist
```
**Failed**: Overcomplicated and didn't solve module resolution during build

### ‚ùå Attempt 4: Wrong Package Exports
```json
{
  "main": "./dist/src/index.js",
  "types": "./dist/src/index.d.ts"
}
```
**Failed**: Didn't match actual TypeScript compilation output

## üõ†Ô∏è Debug Commands for Railway Issues

When troubleshooting Railway deployments:

```bash
# Test contracts build locally
cd libs/contracts && npm run build && ls -la dist/

# Test backend compilation locally
cd apps/backend && npx tsc --noEmit

# Check if contracts can be resolved
cd apps/backend && node -e "console.log(require.resolve('@bassnotion/contracts'))"

# Test full Docker build locally
docker build -f Dockerfile.final -t bassnotion-backend .

# Run container locally to test
docker run -p 3000:3000 bassnotion-backend

# Check health endpoint
curl http://localhost:3000/api/health
```

## üö® Red Flags - Fix These Immediately

‚ùå **Cryptic `[object Object]` errors** ‚Üí Add `ENV NX_DAEMON=false`  
‚ùå **Module not found errors for contracts** ‚Üí Copy built contracts to node_modules  
‚ùå **Health check failures with no logs** ‚Üí Check if app is actually starting  
‚ùå **Deployment skipped** ‚Üí Update watch patterns or trigger manually  
‚ùå **Package exports pointing to wrong paths** ‚Üí Align with TypeScript output  
‚ùå **Complex production dependency management** ‚Üí Copy working node_modules instead  

## üìä Deployment Timeline

1. **Initial Health Check Failures**: Service not starting due to module issues
2. **Watch Pattern Fix**: Added missing file patterns to trigger deployments
3. **Module Resolution Investigation**: Discovered contracts import failures
4. **Nx Daemon Issues**: Cryptic errors masking real TypeScript problems
5. **Clear Error Messages**: Disabled daemon revealed module resolution issues
6. **Docker Strategy Evolution**: Multiple attempts to fix module availability
7. **Final Success**: ‚úÖ Copy built contracts to node_modules before backend build

## üéâ Current Status

- **Deployment Status**: ‚úÖ Live and functional
- **Build Time**: ~3-4 minutes (including Docker multi-stage)
- **Health Check**: `/api/health` endpoint responding correctly
- **Module Resolution**: All contracts imports working
- **Dependencies**: Properly resolved in both build and runtime

**Live URL**: https://backend-production-612c.up.railway.app

## üìã Pre-Deployment Checklist

Before deploying to Railway, verify:

‚úÖ **Contracts Library**: Builds successfully (`cd libs/contracts && npm run build`)  
‚úÖ **Package Exports**: Match actual TypeScript compilation output  
‚úÖ **Path Mappings**: Align between tsconfig.base.json and package.json  
‚úÖ **Dockerfile**: Includes contracts copying step before backend build  
‚úÖ **Nx Daemon**: Disabled with `ENV NX_DAEMON=false`  
‚úÖ **Watch Patterns**: Include all relevant files in railway.json  
‚úÖ **Health Endpoint**: Accessible and returns proper status  

## üîç Success Criteria

A successful Railway deployment should:

‚úÖ Build contracts library without errors  
‚úÖ Copy contracts to node_modules for module resolution  
‚úÖ Build backend with all imports resolved  
‚úÖ Start application successfully  
‚úÖ Pass health checks at `/api/health`  
‚úÖ Respond to HTTP requests  
‚úÖ Log startup messages without errors  

---

**Last Updated**: May 2025  
**Status**: ‚úÖ Production Ready  
**Maintainer**: Development Team 